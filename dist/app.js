var F=window.__PLAYER0_API_URL||`${window.location.origin}/api`;var F1=604800000,m=new Map;function T1(){try{if(window.__PLAYER0_DEV_MODE===!0)return!0;let $=new URLSearchParams(window.location.search).get("dev");if($===""||$==="1"||$==="true")return!0;let M=localStorage.getItem("player0.devMode");if(M==="1"||M==="true")return!0;let J=window.location.hostname;if(J==="localhost"||J==="127.0.0.1")return!0}catch{}return!1}function n(E){return E}function j1(E){let $=m.get(E);if($&&Date.now()-$.timestamp<F1)return $.data;return m.delete(E),null}function H1(E,$){m.set(E,{data:$,timestamp:Date.now()})}function h(){m.clear()}async function s(E,$={}){let M=n(E);if(T1()){let G=new Headers($.headers||{});G.set("Cache-Control","no-cache");let X=await fetch(E,{...$,headers:G,cache:"no-store"}),Y=await X.json();if(!X.ok)throw Error(Y.message||"API request failed");return Y}if(!$.method||$.method==="GET"){let G=j1(M);if(G)return G}let J=await fetch(E,$),B=await J.json();if(!J.ok)throw Error(B.message||"API request failed");if(!$.method||$.method==="GET")H1(M,B);return B}async function BE(E,$=5){if(!E||E.length<2)return{artists:[],albums:[],songs:[],genres:[]};let M=await fetch(`${F}/suggestions?q=${encodeURIComponent(E)}&limit=${$}`),J=await M.json();if(!M.ok)throw Error(J.message||"Error getting suggestions");return J}async function GE(E){let $=await fetch(`${F}/search?q=${encodeURIComponent(E)}`),M=await $.json();if(!$.ok)throw Error(M.message||"Error performing search");return M}async function x0({title:E,artist:$,album:M,genre:J,year:B,minDuration:G,maxDuration:X}={}){let Y=new URLSearchParams;if(E)Y.append("title",E);if($)Y.append("artist",$);if(M)Y.append("album",M);if(J)Y.append("genre",J);if(B)Y.append("year",B);if(G)Y.append("minDuration",G);if(X)Y.append("maxDuration",X);let Z=await fetch(`${F}/search?${Y}`),O=await Z.json();if(!Z.ok)throw Error(O.message||"Error performing advanced search");return O}async function Q(){return await s(`${F}/songs`)}function M0(E){return`${F}/cover/${E}`}function XE(E){return`${F}/stream/${E}`}async function YE(E){let $=await fetch(`${F}/play/${E}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({durationPlayed:0})});if(!$.ok){let M=await $.json();throw Error(M.message||"Error recording play")}return $.json()}async function ZE(){return await s(`${F}/albums`)}async function KE(E,$){return await s(`${F}/albums/${encodeURIComponent(E)}/${encodeURIComponent($)}`)}function J0(E){return`${F}/cover/${E}`}async function fE(){return await s(`${F}/artists`)}async function t(){return await s(`${F}/playlists`)}async function a(E){return await s(`${F}/playlists/${E}`)}async function B0(E,$="",M=[]){let J=await fetch(`${F}/playlists`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:E,description:$,songIds:M})});if(!J.ok){let B=await J.json();throw Error(B.error||"Failed to create playlist")}return m.delete(n(`${F}/playlists`)),await J.json()}async function g(E,$){let M=await fetch(`${F}/playlists/${E}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!M.ok){let J=await M.json();throw Error(J.error||"Failed to update playlist")}return m.delete(n(`${F}/playlists/${E}`)),m.delete(n(`${F}/playlists`)),await M.json()}async function VE(E){let $=await fetch(`${F}/playlists/${E}`,{method:"DELETE"});if(!$.ok){let M=await $.json();throw Error(M.error||"Failed to delete playlist")}return m.delete(n(`${F}/playlists/${E}`)),m.delete(n(`${F}/playlists`)),await $.json()}async function OE(E,$){let M=await a(E),J=M.songIds||[];if(J.includes($))return M;return await g(E,{songIds:[...J,$]})}async function WE(E,$){let J=((await a(E)).songIds||[]).filter((B)=>B!==$);return await g(E,{songIds:J})}async function zE(){let E=await fetch(`${F}/stats`,{cache:"no-store"}),$=await E.json();if(!E.ok)throw Error($.message||"API request failed");return $}async function NE(){let E=await fetch(`${F}/scan`,{method:"POST"}),$=await E.json();if(!E.ok)throw Error($.error||$.message||"Error scanning library");return h(),$}var RE=[],S=[],z=[],R=-1,Q1=!1,y=!1,c="off";function G0(E){let $=Number(E);return Number.isFinite($)?Math.trunc($):0}function W0(E,$,M){return Math.min(M,Math.max($,E))}function j(E){S=E}function k(E,$=0){if(z=Array.isArray(E)?E:[],z.length===0){R=-1;return}R=W0(G0($),0,z.length-1)}function z0(E){Q1=E}function e(E){y=Boolean(E)}function _E(){if(y=!y,y)FE();return y}function E0(E){if(E==="off"||E==="one"||E==="all")c=E}function UE(){return c=c==="off"?"all":c==="all"?"one":"off",c}function C1(E){for(let $=E.length-1;$>0;$--){let M=Math.floor(Math.random()*($+1));[E[$],E[M]]=[E[M],E[$]]}return E}function FE(){if(!z.length)return;let E=Math.max(0,R+1);if(E>=z.length-1)return;let $=z.slice(E);C1($),z.splice(E,z.length-E,...$)}function TE(){return R>=0&&R<z.length-1}function jE(){return R>0}function HE(){if(TE())return R++,z[R];return null}function QE(){if(jE())return R--,z[R];return null}function CE(){return z[R]||null}function N0(E){if(!z.length){R=-1;return}R=W0(G0(E),0,z.length-1)}function S0(E,$){let M=G0(E);if(M<0||M>=z.length)return;let J=W0(G0($),0,z.length-1);if(M===J)return;let[B]=z.splice(M,1);if(z.splice(J,0,B),M===R){R=J;return}if(M<R&&J>=R)R-=1;else if(M>R&&J<=R)R+=1}function DE(E){let $=G0(E);if($<0||$>=z.length)return null;let M=$===R,[J]=z.splice($,1);if(z.length===0)return R=-1,{removed:J,removedWasCurrent:M,newIndex:-1};if($<R)R-=1;else if(M)R=W0($,0,z.length-1);return{removed:J,removedWasCurrent:M,newIndex:R}}function qE(E){let M=(Array.isArray(E)?E:[E]).filter(Boolean);if(M.length===0)return;if(!z.length){z=[...M],R=0;return}z.push(...M)}function AE(E){let M=(Array.isArray(E)?E:[E]).filter(Boolean);if(M.length===0)return;if(!z.length){z=[...M],R=0;return}let J=R>=0?R+1:z.length;z.splice(J,0,...M)}function x(E){if(!E||isNaN(E))return"0:00";let $=Math.floor(E/60),M=Math.floor(E%60);return`${$}:${M.toString().padStart(2,"0")}`}function U(E){let $=document.createElement("div");return $.textContent=E,$.innerHTML}function kE(E,$){let M;return function(...B){let G=()=>{clearTimeout(M),E(...B)};clearTimeout(M),M=setTimeout(G,$)}}var R0=null;function wE(){if(R0)return;if(!("IntersectionObserver"in window)){console.log("IntersectionObserver not supported, loading all images immediately");return}R0=new IntersectionObserver((E,$)=>{E.forEach((M)=>{if(M.isIntersecting){let J=M.target,B=J.dataset.src;if(B)J.src=B,J.removeAttribute("data-src"),J.classList.remove("lazy"),J.classList.add("loaded");$.unobserve(J)}})},{rootMargin:"100px 0px",threshold:0.01})}function D1(E){if(!R0){let $=E.dataset.src;if($)E.src=$,E.removeAttribute("data-src");return}R0.observe(E)}function P0(E=document){E.querySelectorAll("img[data-src]").forEach((M)=>D1(M))}function I0(E,$,M=""){let J=U(E),B=U($),G=M?`class="${U(M)} lazy"`:'class="lazy"',X='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E';return`<img ${G} src="data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E" data-src="${J}" alt="${B}" loading="lazy" />`}var _=null,_0=null,X0=!1,cE=8,P=null,U0=!1;function LE(){try{return Boolean(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches)}catch{return!1}}function m0(E){E.querySelectorAll(".queue-item.is-drag-over, .queue-item.is-touch-dragging").forEach(($)=>{$.classList.remove("is-drag-over","is-touch-dragging")})}function q1(E,$,M,J){if(!E||E.button===2)return;if(P={pointerId:E.pointerId,fromIndex:$,toIndex:null,queueList:J},m0(J),M.classList.add("is-touch-dragging"),J.classList.add("is-touch-dragging"),!U0)document.addEventListener("pointermove",vE,{passive:!1}),document.addEventListener("pointerup",F0),document.addEventListener("pointercancel",F0),U0=!0}function vE(E){if(!P)return;if(E.pointerId!==P.pointerId)return;E.preventDefault();let $=P.queueList,J=document.elementFromPoint(E.clientX,E.clientY)?.closest?.(".queue-item");if(!J||!$.contains(J))return;let B=Number(J.dataset.playbackIndex);if(!Number.isFinite(B))return;let G=J.getBoundingClientRect(),X=E.clientY-G.top>G.height/2,Y=xE(P.fromIndex,B,X);m0($),J.classList.add("is-drag-over"),P.toIndex=Y}function F0(E){if(!P)return;if(E.pointerId!==P.pointerId)return;let{queueList:$,fromIndex:M,toIndex:J}=P;if(P=null,U0)document.removeEventListener("pointermove",vE),document.removeEventListener("pointerup",F0),document.removeEventListener("pointercancel",F0),U0=!1;if($.classList.remove("is-touch-dragging"),m0($),J==null||M===J)return;S0(M,J),I()}function y0(E){document.body.classList.toggle("has-mini-player",Boolean(E));let $=document.getElementById("miniPlayer");if(!$)return;if(!E){$.style.display="none",$.style.transform="translateY(100%)";return}let M=document.querySelector(".app-container");if(!Boolean(M?.classList.contains("sidebar-closed")))return;$.style.display="flex",requestAnimationFrame(()=>{$.style.transform="translateY(0)"})}function hE(E){_=E,_.addEventListener("timeupdate",k1),_.addEventListener("ended",Y0),_.addEventListener("play",()=>{z0(!0),b0()}),_.addEventListener("pause",()=>{z0(!1),b0()}),A1(),T0(),document.getElementById("toggleQueueExpanded")?.addEventListener("click",()=>{X0=!X0,I()}),I(),y0(Boolean(CE()))}function A1(){let E=document.getElementById("shuffleButton"),$=document.getElementById("repeatButton");if(E)E.addEventListener("click",(M)=>{M.preventDefault(),_E(),T0(),I()});if($)$.addEventListener("click",(M)=>{M.preventDefault(),UE(),T0()})}function xE(E,$,M){let J=$+(M?1:0);if(E<J)J-=1;return J}function T0(){let E=document.getElementById("shuffleButton"),$=document.getElementById("repeatButton");if(E)E.classList.toggle("is-active",Boolean(y)),E.title=y?"Shuffle: On":"Shuffle: Off";if($){let M=c==="one"?"Repeat: One":c==="all"?"Repeat: All":"Repeat: Off";if($.title=M,$.classList.toggle("is-active",c!=="off"),c==="one")$.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><path d="M12 8v8"/><path d="M10.5 10.5L12 9l1.5 1.5"/><path d="M10.5 15.5L12 17l1.5-1.5"/></svg>';else $.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>'}}function H(E){if(!E||!_)return;_.src=XE(E.id),_.play(),document.getElementById("npTitle").textContent=E.title||"Unknown",document.getElementById("npArtist").textContent=E.artist||"Unknown Artist",document.getElementById("miniTitle").textContent=E.title||"Unknown",document.getElementById("miniArtist").textContent=E.artist||"Unknown Artist";let $=document.getElementById("npArtwork");$.onerror=()=>{$.style.display="none"},$.src=J0(E.id),$.style.display="block",y0(!0),T0(),I(),w1(E.id)}function j0(){if(!_)return;if(_.paused)_.play();else _.pause()}function Y0(){if(!z.length)return;if(c==="one"){if(_)_.currentTime=0,_.play();return}let E=HE();if(E){H(E);return}if(c==="all"){if(y&&z.length>1){let $=[...z].sort(()=>Math.random()-0.5);k($,0),H($[0]);return}N0(0),H(z[0])}}function H0(){if(!z.length)return;if(_&&_.currentTime>3){_.currentTime=0;return}let E=QE();if(E){H(E);return}if(c==="all"){let $=Math.max(0,z.length-1);N0($),H(z[$])}}function k1(){if(!_)return;let E=_.currentTime/_.duration*100;document.getElementById("progressBar").value=E||0,document.getElementById("currentTime").textContent=x(_.currentTime),document.getElementById("totalTime").textContent=x(_.duration);let $=document.getElementById("miniProgressFill");if($)$.style.width=`${E||0}%`}function b0(){let E=document.getElementById("playPauseButton"),$=document.getElementById("miniPlayPause");if(!E||!$)return;if(!_.paused)E.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>',$.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>';else E.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M8 5v14l11-7z"/></svg>',$.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M8 5v14l11-7z"/></svg>'}function I(){let E=document.getElementById("queueList");if(!E)return;let $=document.getElementById("toggleQueueExpanded");if($){let B=z.length>cE;$.style.display=B?"inline-flex":"none",$.textContent=X0?"Less":"More",$.setAttribute("aria-expanded",X0?"true":"false")}if(E.innerHTML="",!z.length){E.innerHTML='<p class="empty-queue">Queue is empty</p>';return}let M=0,J=z.length;if(!X0){let B=cE,G=Math.max(0,R);M=Math.max(0,G-Math.floor(B/2)),J=Math.min(z.length,M+B),M=Math.max(0,J-B)}for(let B=M;B<J;B++){let G=z[B],X=document.createElement("div");X.className="queue-item"+(B===R?" active":""),X.dataset.playbackIndex=String(B);let Y=document.createElement("div");if(Y.className="queue-handle",Y.textContent="⋮⋮",Y.draggable=!LE(),Y.setAttribute("aria-label","Drag to reorder"),LE())Y.addEventListener("pointerdown",(K)=>{if(K.pointerType==="mouse")return;K.preventDefault(),q1(K,B,X,E)},{passive:!1});let Z=document.createElement("div");Z.className="queue-meta";let O=document.createElement("div");O.className="queue-title",O.textContent=G?.title||"Unknown";let V=document.createElement("div");V.className="queue-artist",V.textContent=G?.artist||"Unknown Artist",Z.appendChild(O),Z.appendChild(V);let f=document.createElement("button");f.type="button",f.className="queue-remove",f.setAttribute("aria-label","Remove from queue"),f.textContent="✕",X.appendChild(Y),X.appendChild(Z),X.appendChild(f),X.addEventListener("dblclick",()=>{if(!z[B])return;N0(B),H(z[B])}),Y.addEventListener("dragstart",(K)=>{if(_0=B,X.classList.add("is-dragging"),K.dataTransfer)K.dataTransfer.effectAllowed="move",K.dataTransfer.setData("text/plain",String(B))}),Y.addEventListener("dragend",()=>{_0=null,X.classList.remove("is-dragging"),E.querySelectorAll(".queue-item.is-drag-over").forEach((K)=>{K.classList.remove("is-drag-over")})}),f.addEventListener("click",(K)=>{K.preventDefault(),K.stopPropagation();let W=DE(B);if(!W)return;if(W.removedWasCurrent)if(W.newIndex>=0)H(z[W.newIndex]);else{if(_)_.pause(),_.removeAttribute("src"),_.load();z0(!1),b0();let N=document.getElementById("npTitle"),T=document.getElementById("npArtist"),q=document.getElementById("miniTitle"),b=document.getElementById("miniArtist");if(N)N.textContent="No song playing";if(T)T.textContent="";if(q)q.textContent="No song playing";if(b)b.textContent="";y0(!1)}I()}),X.addEventListener("dragover",(K)=>{if(_0==null)return;K.preventDefault(),E.querySelectorAll(".queue-item.is-drag-over").forEach((W)=>{if(W!==X)W.classList.remove("is-drag-over")}),X.classList.add("is-drag-over")}),X.addEventListener("dragleave",()=>{X.classList.remove("is-drag-over")}),X.addEventListener("drop",(K)=>{K.preventDefault();let W=_0;if(W==null){let i=K.dataTransfer?.getData("text/plain"),p=Number(i);W=Number.isFinite(p)?Math.trunc(p):null}let N=Number(X.dataset.playbackIndex);if(W==null||!Number.isFinite(N))return;let T=X.getBoundingClientRect(),q=K.clientY-T.top>T.height/2,b=xE(W,N,q);if(X.classList.remove("is-drag-over"),W===b)return;S0(W,b),I()}),E.appendChild(X)}}async function w1(E){try{await YE(E)}catch($){console.error("Error recording play:",$)}}function SE(E){if(!_)return;let $=E/100*_.duration;_.currentTime=$}function Q0(E){if(!_)return;_.volume=E/100}function L(E,$){let M=document.getElementById("songTableBody");if(!M)return;if(M.innerHTML="",E.length===0){M.innerHTML=`
    <tr>
      <td colspan="8" class="empty-state">
        <div class="empty-state-content">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
            <path d="M9 18V5l12-2v13M9 18l-5 1V6l5-1M9 18l5-1m0-13V6"/>
          </svg>
          <h3>No Songs Found</h3>
          <p>Click "Scan Library" to add your music</p>
        </div>
      </td>
    </tr>`;return}E.forEach((J,B)=>{let G=document.createElement("tr"),X=J.album||"Unknown Album",Y=X.length>30?X.substring(0,30)+"...":X,Z=J.artist||"Unknown Artist",O=J.playCount||0,V=x(J.duration),f=`${J.title||"Unknown"} — ${Z}`;G.innerHTML=`
      <td class="col-play">
        <button class="play-button" data-index="${B}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
      </td>
      <td class="col-cover">
        ${I0(M0(J.id),J.title||"Unknown","song-cover")}
      </td>
      <td class="col-title">
        <div class="song-title-row">
          <div class="song-title-text">${U(J.title||"Unknown")}</div>
          <div class="song-subtitle">
            <span class="song-sub-artist">${U(Z)}</span>
            <span class="song-sub-sep">•</span>
            <span class="song-sub-album" title="${U(X)}">${U(Y)}</span>
            <span class="song-sub-sep">•</span>
            <span class="song-sub-plays">${O} plays</span>
          </div>
        </div>
      </td>
      <td class="col-artist">${U(Z)}</td>
      <td class="col-album" title="${U(X)}">${U(Y)}</td>
      <td class="col-duration">${U(V)}</td>
      <td class="col-plays">${O}</td>
      <td class="col-add">
        <div class="dropdown">
          <button class="dropdown-trigger is-compact" type="button" data-dropdown-trigger aria-haspopup="menu" aria-expanded="false" title="Song actions">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" aria-hidden="true">
              <circle cx="5" cy="12" r="1.8" />
              <circle cx="12" cy="12" r="1.8" />
              <circle cx="19" cy="12" r="1.8" />
            </svg>
          </button>
          <div class="dropdown-menu" role="menu">
            <button class="dropdown-item song-row-play-btn" type="button">Play</button>
            <button class="dropdown-item song-row-play-next-btn" type="button" data-song-id="${J.id}" data-song-index="${B}" data-song-context="library">Play next</button>
            <button class="dropdown-item song-row-queue-btn" type="button" data-song-id="${J.id}" data-song-index="${B}" data-song-context="library">Add to queue</button>
            <div class="dropdown-sep" role="separator"></div>
            <button class="dropdown-item add-to-playlist-btn" type="button" data-song-id="${J.id}">Add to playlist</button>
            <button class="dropdown-item song-copy-btn" type="button" data-copy-text="${U(f)}">Copy title + artist</button>
          </div>
        </div>
      </td>
    `,G.querySelector(".play-button").addEventListener("click",()=>$(B)),G.querySelector(".song-row-play-btn")?.addEventListener("click",()=>$(B)),G.addEventListener("dblclick",()=>$(B)),M.appendChild(G)}),P0(M)}function PE(E,$){let M=document.getElementById("albumGrid");if(!M)return;if(M.innerHTML="",E.length===0){M.innerHTML=`<div class="empty-state-content">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
      <h3>No Albums Found</h3>
      <p>Your albums will appear here once you scan your library</p>
    </div>`;return}E.forEach((J)=>{let B=document.createElement("div");B.className="album-card";let G=J.songs&&J.songs[0]?J0(J.songs[0].id):"",X=J.album||"Unknown Album",Y=X.length>25?X.substring(0,25)+"...":X;B.innerHTML=`
      <div class="album-cover-wrapper">
        ${G?I0(G,X,"album-artwork"):""}
        <div class="album-placeholder">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </div>
      </div>
      <h3 title="${U(X)}">${U(Y)}</h3>
      <p>${U(J.artist||"Unknown Artist")}</p>
      <p style="font-size: 12px; margin-top: 4px;">${J.songCount} songs</p>
    `,B.addEventListener("click",()=>$(J.artist,J.album)),M.appendChild(B)}),P0(M)}function IE(E,$){document.getElementById("albumTitle").textContent=E.album,document.getElementById("albumArtist").textContent=E.artist,document.getElementById("albumMeta").textContent=`${E.year||"Unknown Year"} • ${E.songs.length} songs • ${x(E.duration)}`;let M=document.getElementById("albumArtwork");if(M.style.display="block",E.songs&&E.songs[0])M.onerror=()=>{M.style.display="none"},M.src=J0(E.songs[0].id);else M.style.display="none";let J=document.getElementById("albumSongTableBody");J.innerHTML="",E.songs.forEach((B,G)=>{let X=document.createElement("tr");X.innerHTML=`
      <td class="col-track">${B.trackNumber||"-"}</td>
      <td class="col-play">
        <button class="play-button" data-index="${G}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
      </td>
      <td class="col-title">${U(B.title)}</td>
      <td class="col-duration">${x(B.duration)}</td>
    `,X.querySelector(".play-button").addEventListener("click",()=>$(G)),X.addEventListener("dblclick",()=>$(G)),J.appendChild(X)})}function bE(E,$){let M=document.getElementById("artistList");if(!M)return;if(M.innerHTML="",E.length===0){M.innerHTML=`<div class="empty-state-content">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      <h3>No Artists Found</h3>
      <p>Artists will appear here after scanning your music</p>
    </div>`;return}E.forEach((J)=>{let B=document.createElement("div");B.className="artist-item",B.innerHTML=`
      <div>
        <div class="artist-name">${U(J.name)}</div>
        <div class="artist-meta">${J.songCount} songs • ${J.albumCount} albums</div>
      </div>
    `,B.addEventListener("click",()=>$(J.name)),M.appendChild(B)})}function C0(E){let $=document.getElementById("playlistGrid");if(!$)return;if($.innerHTML="",!E||E.length===0){$.innerHTML=`
      <div class="empty-state-content">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
        </svg>
        <h3>No Playlists Yet</h3>
        <p>Create your first playlist to organize your music</p>
      </div>`;return}(E||[]).forEach((M)=>{let J=document.createElement("div");J.className="playlist-card",J.dataset.playlistId=M.id,J.dataset.pinned=M.pinned?"1":"0",J.innerHTML=`
      <button class="playlist-pin-btn" type="button" data-playlist-id="${M.id}" data-pinned="${M.pinned?"1":"0"}" aria-label="${M.pinned?"Unpin playlist":"Pin playlist"}" title="${M.pinned?"Pinned":"Pin"}">
        <svg viewBox="0 0 24 24" fill="${M.pinned?"currentColor":"none"}" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M12 17l-5 3 1.5-5.5L4 10.5l5.7-.4L12 5l2.3 5.1 5.7.4-4.5 4 1.5 5.5z"/>
        </svg>
      </button>
      <div class="playlist-cover">
        <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
          <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
        </svg>
      </div>
      <div class="playlist-info">
        <h3>${U(M.name)}</h3>
        <p>${M.songCount||0} songs</p>
      </div>
    `,J.addEventListener("click",()=>{if(window.loadPlaylistDetail)window.loadPlaylistDetail(M.id)}),$.appendChild(J)})}function mE(E){let $=document.getElementById("statsLayout");if(!$)return;if(!(E&&E.totalSongs>0)){$.innerHTML=`<div class="empty-state-content" style="grid-column: 1 / -1;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
        <path d="M3 3v18h18"/>
        <path d="M7 16V9M12 16V6M17 16v-4"/>
      </svg>
      <h3>No Statistics Yet</h3>
      <p>Start playing some music to see your stats</p>
    </div>`;return}let J=5,B=(E.mostPlayed||[]).slice(0,J),G=(E.recentlyPlayed||[]).slice(0,J),X=c1(E.totalListeningTime||0);$.innerHTML=`
    <div class="stat-tile tile-most" role="button" tabindex="0" aria-label="Most Played Songs" data-stats-action="modal" data-stats-modal="mostPlayed">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Most Played</div>
        <div class="stat-tile-hint">Open list</div>
      </div>
      <div class="stat-preview">
        ${B.length?B.map((Y)=>`
          <div class="stat-preview-item">
            <div style="min-width: 0;">
              <div class="stat-preview-primary">${U(Y.title||"Unknown")}</div>
              <div class="stat-preview-secondary">${U(Y.artist||"Unknown Artist")}</div>
            </div>
            <div class="stat-preview-right">${Y.playCount||0} plays</div>
          </div>
        `).join(""):`
          <div class="stat-preview-item">
            <div style="min-width: 0;">
              <div class="stat-preview-primary">No plays recorded</div>
              <div class="stat-preview-secondary">Play some music to populate this</div>
            </div>
          </div>
        `}
      </div>
    </div>

    <div class="stat-tile tile-songs" role="button" tabindex="0" aria-label="Open Songs" data-stats-action="navigate" data-stats-target="library">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Songs</div>
        <div class="stat-tile-value">${E.totalSongs||0}</div>
      </div>
      <div class="stat-tile-hint">Open songs</div>
    </div>

    <div class="stat-tile tile-artists" role="button" tabindex="0" aria-label="Open Artists" data-stats-action="navigate" data-stats-target="artists">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Artists</div>
        <div class="stat-tile-value">${E.uniqueArtists||0}</div>
      </div>
      <div class="stat-tile-hint">Open artists</div>
    </div>

    <div class="stat-tile tile-albums" role="button" tabindex="0" aria-label="Open Albums" data-stats-action="navigate" data-stats-target="albums">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Albums</div>
        <div class="stat-tile-value">${E.uniqueAlbums||0}</div>
      </div>
      <div class="stat-tile-hint">Open albums</div>
    </div>

    <div class="stat-tile tile-playlists" role="button" tabindex="0" aria-label="Open Playlists" data-stats-action="navigate" data-stats-target="playlists">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Playlists</div>
        <div class="stat-tile-value">${E.totalPlaylists||0}</div>
      </div>
      <div class="stat-tile-hint">Open playlists</div>
    </div>

    <div class="stat-tile tile-genres" role="button" tabindex="0" aria-label="Genres" data-stats-action="modal" data-stats-modal="genres">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Genres</div>
        <div class="stat-tile-value">${E.uniqueGenres||0}</div>
      </div>
      <div class="stat-tile-hint">Open list</div>
    </div>

    <div class="stat-tile tile-totals" role="button" tabindex="0" aria-label="Totals" data-stats-action="modal" data-stats-modal="summary">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Totals</div>
        <div class="stat-tile-value">${E.totalPlays||0}</div>
      </div>
      <div class="stat-tile-hint">Listening: ${U(X)} • ${U(x(E.totalDuration||0))} library • open details</div>
    </div>

    <div class="stat-tile tile-recent" role="button" tabindex="0" aria-label="Recently Played" data-stats-action="modal" data-stats-modal="recentlyPlayed">
      <div class="stat-tile-header">
        <div class="stat-tile-title">Recently Played</div>
        <div class="stat-tile-hint">Open list</div>
      </div>
      <div class="stat-preview">
        ${G.length?G.map((Y)=>{let Z=Y.playedAt?L1(new Date(Y.playedAt)):"";return`
            <div class="stat-preview-item">
              <div style="min-width: 0;">
                <div class="stat-preview-primary">${U(Y.title||"Unknown")}</div>
                <div class="stat-preview-secondary">${U(Y.artist||"Unknown Artist")}</div>
              </div>
              <div class="stat-preview-right">${U(Z)}</div>
            </div>
          `}).join(""):`
          <div class="stat-preview-item">
            <div style="min-width: 0;">
              <div class="stat-preview-primary">No recent plays</div>
              <div class="stat-preview-secondary">Start playing music to populate this</div>
            </div>
          </div>
        `}
      </div>
    </div>
  `}function c1(E){let $=Number(E);if(!Number.isFinite($)||$<=0)return"0m";let M=Math.floor($/60),J=M%60,B=Math.floor(M/60),G=B%24,X=Math.floor(B/24);if(X>0)return`${X}d ${G}h`;if(B>0)return`${B}h ${J}m`;return`${M}m`}function L1(E){let $=Math.floor((new Date-E)/1000);if($<60)return"Just now";let M=Math.floor($/60);if(M<60)return`${M}m ago`;let J=Math.floor(M/60);if(J<24)return`${J}h ago`;return`${Math.floor(J/24)}d ago`}function p0(E,$){let M=document.getElementById("playlistDetailName"),J=document.getElementById("playlistDetailDescription"),B=document.getElementById("playlistDetailTableBody");if(!B||!M||!J)return;M.textContent=E.name||"Untitled Playlist";let G=`${($||[]).length} songs`,X=String(E.description||"").trim();if(J.textContent=X?`${X} • ${G}`:G,B.innerHTML="",!$||$.length===0){B.innerHTML=`
      <tr>
        <td colspan="8" class="empty-state">
          <div class="empty-state-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
            <h3>No Songs in This Playlist</h3>
            <p>Add songs using the + button in your library</p>
          </div>
        </td>
      </tr>`;return}$.forEach((V,f)=>{let K=document.createElement("tr"),W=V.album||"Unknown Album",N=W.length>30?W.substring(0,30)+"...":W,T=V.artist||"Unknown Artist",q=`${V.title||"Unknown"} — ${T}`;K.innerHTML=`
      <td class="col-drag">
        <span class="playlist-drag-handle" draggable="true" aria-label="Drag to reorder">⋮⋮</span>
      </td>
      <td class="col-play">
        <button class="play-button" data-index="${f}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
      </td>
      <td class="col-cover">
        <img class="song-cover" src="${M0(V.id)}" alt="${U(V.title||"Unknown")}" onerror="this.style.display='none';" />
      </td>
      <td class="col-title">${U(V.title||"Unknown")}</td>
      <td class="col-artist">${U(T)}</td>
      <td class="col-album" title="${U(W)}">${U(N)}</td>
      <td class="col-duration">${x(V.duration)}</td>
      <td class="col-remove">
        <div class="dropdown">
          <button class="dropdown-trigger is-compact" type="button" data-dropdown-trigger aria-haspopup="menu" aria-expanded="false" title="Song actions">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" aria-hidden="true">
              <circle cx="5" cy="12" r="1.8" />
              <circle cx="12" cy="12" r="1.8" />
              <circle cx="19" cy="12" r="1.8" />
            </svg>
          </button>
          <div class="dropdown-menu" role="menu">
            <button class="dropdown-item song-row-play-btn" type="button">Play</button>
            <button class="dropdown-item song-row-play-next-btn" type="button" data-song-id="${V.id}" data-song-index="${f}" data-song-context="playlist">Play next</button>
            <button class="dropdown-item song-row-queue-btn" type="button" data-song-id="${V.id}" data-song-index="${f}" data-song-context="playlist">Add to queue</button>
            <div class="dropdown-sep" role="separator"></div>
            <button class="dropdown-item add-to-playlist-btn" type="button" data-song-id="${V.id}">Add to playlist</button>
            <button class="dropdown-item song-copy-btn" type="button" data-copy-text="${U(q)}">Copy title + artist</button>
            <div class="dropdown-sep" role="separator"></div>
            <button class="dropdown-item is-danger remove-from-playlist-btn" type="button" data-song-id="${V.id}">Remove from playlist</button>
          </div>
        </div>
      </td>
    `,B.appendChild(K)}),B.querySelectorAll(".play-button").forEach((V)=>{V.addEventListener("click",(f)=>{f.stopPropagation();let K=parseInt(V.dataset.index);if(window.onPlaySongFromPlaylist)window.onPlaySongFromPlaylist($,K)})}),B.querySelectorAll(".song-row-play-btn").forEach((V)=>{V.addEventListener("click",(f)=>{f.stopPropagation();let W=V.closest("tr")?.querySelector?.(".play-button"),N=parseInt(W?.dataset?.index);if(!Number.isFinite(N))return;if(window.onPlaySongFromPlaylist)window.onPlaySongFromPlaylist($,N)})});let Y=null;function Z(V,f,K){let W=f+(K?1:0);if(V<W)W-=1;return W}function O(V){return V.map((f)=>f.id).filter(Boolean)}B.querySelectorAll("tr").forEach((V,f)=>{let K=V.querySelector(".playlist-drag-handle");if(!K)return;K.addEventListener("dragstart",(W)=>{if(Y=f,V.classList.add("is-dragging"),W.dataTransfer)W.dataTransfer.effectAllowed="move",W.dataTransfer.setData("text/plain",String(f))}),K.addEventListener("dragend",()=>{Y=null,B.querySelectorAll("tr.is-dragging").forEach((W)=>W.classList.remove("is-dragging")),B.querySelectorAll("tr.is-drag-over").forEach((W)=>W.classList.remove("is-drag-over"))}),V.addEventListener("dragover",(W)=>{if(Y==null)return;W.preventDefault(),B.querySelectorAll("tr.is-drag-over").forEach((N)=>{if(N!==V)N.classList.remove("is-drag-over")}),V.classList.add("is-drag-over")}),V.addEventListener("dragleave",()=>{V.classList.remove("is-drag-over")}),V.addEventListener("drop",async(W)=>{W.preventDefault();let N=Y;if(N==null){let h0=W.dataTransfer?.getData("text/plain"),JE=Number(h0);N=Number.isFinite(JE)?Math.trunc(JE):null}if(N==null)return;let T=f,q=V.getBoundingClientRect(),b=W.clientY-q.top>q.height/2,i=Z(N,T,b);if(V.classList.remove("is-drag-over"),N===i)return;let p=[...$],[U1]=p.splice(N,1);p.splice(i,0,U1);let ME=O(p);if(window.currentPlaylistId===E.id)window.currentPlaylistSongs=p;p0({...E,songIds:ME},p);try{await g(E.id,{songIds:ME})}catch(h0){if(console.error("Failed to persist playlist order:",h0),window.loadPlaylistDetail)await window.loadPlaylistDetail(E.id)}})})}function A(E){k([...S],E),H(S[E])}function v1(){e(!1),E0("off"),k([...S],0),H(S[0])}function h1(){e(!0),E0("off");let E=[...S].sort(()=>Math.random()-0.5);k(E,0),H(E[0])}async function yE(){try{let E=await Q();j(E),L(E,A);let $=document.getElementById("playAll"),M=document.getElementById("shuffleAll");if($)$.onclick=()=>v1();if(M)M.onclick=()=>h1()}catch(E){console.error("Error loading songs:",E)}}window.playSongFromList=A;var $0=[];function pE(E){k([...$0],E),H($0[E])}function x1(){e(!1),E0("off"),k([...$0],0),H($0[0])}function S1(){e(!0),E0("off");let E=[...$0].sort(()=>Math.random()-0.5);k(E,0),H(E[0])}async function uE(){try{let E=await ZE();PE(E,u0)}catch(E){console.error("Error loading albums:",E)}}async function u0(E,$){try{let M=await KE(E,$);$0=M.songs,await v("albumDetailView",!1),window.location.hash=`#/album/${encodeURIComponent(E)}/${encodeURIComponent($)}`,await new Promise((X)=>setTimeout(X,0)),IE(M,pE);let J=document.getElementById("playAlbum"),B=document.getElementById("shuffleAlbum"),G=document.getElementById("backToAlbums");if(J)J.onclick=()=>x1();if(B)B.onclick=()=>S1();if(G)G.onclick=()=>{window.location.hash="#/albums"}}catch(M){console.error("Error loading album detail:",M)}}window.playAlbumSong=pE;var C=document.getElementById("searchInput"),r=document.getElementById("advancedSearch"),u=document.getElementById("advancedSearchToggle"),D=null,w=-1,q0=[];function d0(E){if(!r||!u)return;r.style.display=E?"block":"none",u.classList.toggle("active",E)}function o0(){return Boolean(r&&r.style.display==="block")}function oE(){let E=document.querySelector(".search-button");if(!C||!E||!u||!r)return;p1(),C.addEventListener("input",kE(u1,150)),C.addEventListener("keydown",t1),C.addEventListener("keypress",($)=>{if($.key==="Enter")d(),l()}),C.addEventListener("focus",()=>{if(C.value.trim().length>=2&&q0.length>0)tE()}),E.addEventListener("click",()=>{d(),l()}),u.addEventListener("click",()=>{d0(!o0())}),document.addEventListener("focusin",($)=>{if(!o0())return;let M=$.target;if(!M)return;if(r.contains(M))return;if(u===M||u.contains(M))return;d0(!1)}),document.addEventListener("pointerdown",($)=>{if(!o0())return;let M=$.target;if(!M)return;if(r.contains(M))return;if(u===M||u.contains(M))return;d0(!1)},!0),document.getElementById("applyFilters")?.addEventListener("click",()=>{I1()}),document.getElementById("clearFilters")?.addEventListener("click",()=>{b1()}),document.getElementById("discoveryNotPlayed")?.addEventListener("click",()=>{m1()}),document.getElementById("discoveryLowPlays")?.addEventListener("click",()=>{y1()})}function dE(E){return String(E||"").toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim()}function P1(E,$){if(!E)return-1;let M=dE(E),J=dE($);if(!M||!J)return-1;let B=M.split(" ").filter(Boolean),G=0;for(let X of B){let Y=J.indexOf(X);if(Y>=0){G+=100-Math.min(80,Y);continue}let Z=0,O=0;for(let V of X){let f=J.indexOf(V,Z);if(f===-1)return-1;O+=Math.max(0,f-Z),Z=f+1}G+=Math.max(5,60-Math.min(55,O))}return G}async function o(){if(!document.getElementById("songTableBody"))await v("library",!1),await new Promise((E)=>setTimeout(E,0))}async function l(){if(!C)return;let E=C.value.trim();if(await o(),!E){let $=await Q();j($),L($,A);return}try{let $=await GE(E);if($.length>0){j($),L($,A);return}let J=(await Q()).map((B)=>{let G=`${B.title||""} ${B.artist||""} ${B.album||""} ${B.genre||""}`;return{song:B,score:P1(E,G)}}).filter((B)=>B.score>=0).sort((B,G)=>G.score-B.score).slice(0,300).map((B)=>B.song);j(J),L(J,A)}catch($){console.error("Search error:",$)}}async function I1(){await o();let E=document.getElementById("filterArtist")?.value,$=document.getElementById("filterAlbum")?.value,M=document.getElementById("filterGenre")?.value,J=document.getElementById("filterYear")?.value;try{let B=await x0({artist:E,album:$,genre:M,year:J});j(B),L(B,A)}catch(B){console.error("Advanced search error:",B)}}async function b1(){await o();let E=document.getElementById("filterArtist"),$=document.getElementById("filterAlbum"),M=document.getElementById("filterGenre"),J=document.getElementById("filterYear");if(E)E.value="";if($)$.value="";if(M)M.value="";if(J)J.value="";if(C)C.value="";let B=await Q();j(B),L(B,A)}async function m1(){await o();let M=[...await Q()].sort((J,B)=>{let G=J.lastPlayed?Date.parse(J.lastPlayed):0,X=B.lastPlayed?Date.parse(B.lastPlayed):0;if(!J.lastPlayed&&B.lastPlayed)return-1;if(J.lastPlayed&&!B.lastPlayed)return 1;return G-X}).slice(0,300);j(M),L(M,A)}async function y1(){await o();let M=[...await Q()].sort((J,B)=>{let G=Number.isFinite(Number(J.playCount))?Number(J.playCount):0,X=Number.isFinite(Number(B.playCount))?Number(B.playCount):0;if(G!==X)return G-X;let Y=J.lastPlayed?Date.parse(J.lastPlayed):0,Z=B.lastPlayed?Date.parse(B.lastPlayed):0;return Y-Z}).slice(0,300);j(M),L(M,A)}function p1(){if(D)return;D=document.createElement("div"),D.className="search-suggestions",D.style.display="none";let E=C.closest(".search-bar");if(E)E.style.position="relative",E.appendChild(D);document.addEventListener("click",($)=>{if(!C.contains($.target)&&!D.contains($.target))d()})}async function u1(E){let $=C.value.trim();if($.length<2){if(d(),q0=[],$.length===0)l();return}try{let M=await BE($,5);if(q0=d1(M),q0.length>0)o1(M),tE();else d()}catch(M){console.error("Error getting suggestions:",M),d()}}function d1(E){let $=[];if(E.artists?.length)E.artists.forEach((M)=>$.push({...M,category:"artist"}));if(E.albums?.length)E.albums.forEach((M)=>$.push({...M,category:"album"}));if(E.songs?.length)E.songs.forEach((M)=>$.push({...M,category:"song"}));if(E.genres?.length)E.genres.forEach((M)=>$.push({...M,category:"genre"}));return $}function o1(E){if(!D)return;let $="";w=-1;let M={artists:'<svg class="suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2z"/><path d="M9 9h.01M15 9h.01M9 15s1.5 2 3 2 3-2 3-2"/></svg>',albums:'<svg class="suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>',songs:'<svg class="suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',genres:'<svg class="suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>'},J=0;for(let[B,G]of Object.entries(E)){if(!G||G.length===0)continue;let X=B.charAt(0).toUpperCase()+B.slice(1);$+=`<div class="suggestion-category">
      <div class="suggestion-category-header">${M[B]||""} ${X}</div>`;for(let Y of G){let Z=Y.artist?`<span class="suggestion-subtitle">${D0(Y.artist)}</span>`:"";$+=`<div class="suggestion-item" data-index="${J}" data-type="${Y.type}" data-value="${D0(Y.value)}" ${Y.id?`data-id="${Y.id}"`:""} ${Y.artist?`data-artist="${D0(Y.artist)}"`:""}>
        <span class="suggestion-text">${D0(Y.value)}</span>
        ${Z}
      </div>`,J++}$+="</div>"}D.innerHTML=$,D.querySelectorAll(".suggestion-item").forEach((B)=>{B.addEventListener("click",()=>gE(B)),B.addEventListener("mouseenter",()=>{w=parseInt(B.dataset.index,10),t0()})})}function D0(E){let $=document.createElement("div");return $.textContent=E||"",$.innerHTML}function tE(){if(D)D.style.display="block"}function d(){if(D)D.style.display="none";w=-1}function t1(E){if(!D||D.style.display==="none")return;let $=D.querySelectorAll(".suggestion-item");if($.length===0)return;switch(E.key){case"ArrowDown":E.preventDefault(),w=Math.min(w+1,$.length-1),t0();break;case"ArrowUp":E.preventDefault(),w=Math.max(w-1,-1),t0();break;case"Enter":if(w>=0&&$[w])E.preventDefault(),gE($[w]);break;case"Escape":d();break}}function t0(){let E=D?.querySelectorAll(".suggestion-item");if(!E)return;if(E.forEach(($,M)=>{$.classList.toggle("selected",M===w)}),w>=0&&E[w])E[w].scrollIntoView({block:"nearest"})}async function gE(E){let $=E.dataset.type,M=E.dataset.value,J=E.dataset.artist,B=E.dataset.id;switch(d(),$){case"artist":C.value="",document.getElementById("filterArtist")?.setAttribute("value",M),await g1(M);break;case"album":C.value="",await r1(M,J);break;case"song":C.value=M,await l();break;case"genre":C.value="",await l1(M);break;default:C.value=M,await l()}}async function g1(E){await o();try{let $=await g0({artist:E});j($),L($,A)}catch($){console.error("Error searching by artist:",$)}}async function r1(E,$){await o();try{let M={album:E};if($)M.artist=$;let J=await g0(M);j(J),L(J,A)}catch(M){console.error("Error searching by album:",M)}}async function l1(E){await o();try{let $=await g0({genre:E});j($),L($,A)}catch($){console.error("Error searching by genre:",$)}}async function g0(E){return await x0(E)}var rE=document.getElementById("searchInput");async function lE(){try{let E=await fE();bE(E,async($)=>{if(rE)rE.value=$;await v("library"),await l()})}catch(E){console.error("Error loading artists:",E)}}var r0=null;async function nE(){try{r0=await zE(),mE(r0);let E=document.getElementById("statsLayout");if(!E)return;let $=async(M)=>{try{let J=r0;if(!J)return;let B=M.dataset.statsAction,G=M.dataset.statsTarget,X=M.dataset.statsModal;if(B==="navigate"&&G){window.location.hash=`#/${G}`;return}if(B==="modal"&&X){if(X==="mostPlayed"){let Y=(J.mostPlayed||[]).map((Z)=>({songId:Z.id,title:Z.title||"Unknown",subtitle:Z.artist||"Unknown Artist",rightText:`${Z.playCount||0} plays`}));await iE("Most Played Songs",Y);return}if(X==="recentlyPlayed"){let Y=(J.recentlyPlayed||[]).map((Z)=>({songId:Z.songId,title:Z.title||"Unknown",subtitle:Z.artist||"Unknown Artist",rightText:Z.playedAt?new Date(Z.playedAt).toLocaleString():""}));await iE("Recently Played",Y);return}if(X==="genres"){if(Array.isArray(J.genreReport)&&J.genreReport.length){let f=J.genreReport.map((K)=>({title:K.genre,subtitle:`${K.songs} songs • ${K.totalPlays} plays • ${l0(K.listeningTime||0)}`}));Z0("Genre Report",f);return}let Y=await Q(),Z=new Map;(Y||[]).forEach((f)=>{if(!f.genre)return;Z.set(f.genre,(Z.get(f.genre)||0)+1)});let V=Array.from(Z.entries()).sort((f,K)=>{if(K[1]!==f[1])return K[1]-f[1];return String(f[0]).localeCompare(String(K[0]))}).map(([f,K])=>({title:f,subtitle:`${K} songs`}));Z0("Genres",V);return}if(X==="summary"){let Y=()=>{if(Array.isArray(J.albumReport)&&J.albumReport.length){let O=J.albumReport.map((V)=>({title:`${V.album} — ${V.artist}`,subtitle:`${V.tracks} tracks • ${V.totalPlays} plays • ${l0(V.listeningTime||0)}`}));Z0("Album Report",O);return}Z0("Album Report",[])},Z=[{title:"Total Songs",subtitle:String(J.totalSongs||0)},{title:"Artists",subtitle:String(J.uniqueArtists||0)},{title:"Albums",subtitle:String(J.uniqueAlbums||0)},{title:"Genres",subtitle:String(J.uniqueGenres||0)},{title:"Total Playlists",subtitle:String(J.totalPlaylists||0)},{title:"Total Plays",subtitle:String(J.totalPlays||0)},{title:"Library Duration",subtitle:x(J.totalDuration||0)},{title:"Total Listening Time",subtitle:l0(J.totalListeningTime||0)},{title:"Album Report",subtitle:"Open top albums",onClick:Y},{title:"Export Stats (CSV)",subtitle:"Download song-level stats",onClick:()=>{i0()}}];Z0("Totals",Z);return}}}catch(J){console.error("Error activating stats tile:",J)}};if(!E.dataset.statsBound)E.dataset.statsBound="1",E.addEventListener("click",(M)=>{let J=M.target?.closest?.(".stat-tile");if(!J)return;$(J)}),E.addEventListener("keydown",(M)=>{if(M.key!=="Enter"&&M.key!==" ")return;let J=M.target?.closest?.(".stat-tile");if(!J)return;M.preventDefault(),$(J)})}catch(E){console.error("Error loading stats:",E)}}function K0(E){let $=document.createElement("div");return $.textContent=E,$.innerHTML}function Z0(E,$){let M=document.getElementById("statsListModal"),J=document.getElementById("statsListModalTitle"),B=document.getElementById("statsListModalBody");if(!M||!J||!B)return;if(J.textContent=E||"Statistics",B.innerHTML="",!$||$.length===0){B.innerHTML='<div class="stats-list-item"><div class="stats-list-item-title">No items</div><div class="stats-list-item-subtitle">Nothing to show yet</div></div>',M.style.display="flex";return}$.forEach((G)=>{let X=document.createElement("div");X.className="stats-list-item";let Y=typeof G==="string"?G:G?.title||G?.primary||"",Z=typeof G==="string"?"":G?.subtitle||G?.secondary||"";if(typeof G==="object"&&typeof G?.onClick==="function")X.classList.add("is-clickable"),X.tabIndex=0,X.setAttribute("role","button"),X.addEventListener("click",()=>G.onClick()),X.addEventListener("keydown",(O)=>{if(O.key==="Enter"||O.key===" ")O.preventDefault(),G.onClick()});X.innerHTML=`
      <div class="stats-list-item-title">${K0(String(Y))}</div>
      ${Z?`<div class="stats-list-item-subtitle">${K0(String(Z))}</div>`:""}
    `,B.appendChild(X)}),M.style.display="flex"}async function iE(E,$){let M=document.getElementById("statsListModal"),J=document.getElementById("statsListModalTitle"),B=document.getElementById("statsListModalBody");if(!M||!J||!B)return;if(J.textContent=E||"Songs",B.innerHTML="",!$||$.length===0){B.innerHTML='<div class="stats-list-item"><div class="stats-list-item-title">No songs</div><div class="stats-list-item-subtitle">Nothing to show yet</div></div>',M.style.display="flex";return}$.forEach((G)=>{let X=document.createElement("div");X.className="song-list-item",X.style.cursor="pointer",X.dataset.songId=G.songId,X.innerHTML=`
      <img src="${M0(G.songId)}" alt="Cover" class="song-list-cover" onerror="this.style.display='none'">
      <div style="flex: 1; min-width: 0;">
        <div>${K0(G.title||"Unknown")}</div>
        <div style="font-size: 12px; color: var(--text-secondary);">${K0(G.subtitle||"")}</div>
      </div>
      ${G.rightText?`<div style="color: var(--text-secondary); font-size: 12px;">${K0(G.rightText)}</div>`:""}
    `,X.addEventListener("click",async()=>{try{let Y=X.dataset.songId;if(!Y)return;let Z=await Q(),O=Z.findIndex((V)=>V.id===Y);if(O>=0)j(Z),A(O),M.style.display="none"}catch(Y){console.error("Error playing song from stats modal:",Y)}}),B.appendChild(X)}),M.style.display="flex"}function i1(E,$,M="text/plain"){let J=new Blob([$],{type:M}),B=URL.createObjectURL(J),G=document.createElement("a");G.href=B,G.download=E,document.body.appendChild(G),G.click(),G.remove(),URL.revokeObjectURL(B)}function n1(E){let $=String(E??"");if(/[\n\r",]/.test($))return`"${$.replace(/"/g,'""')}"`;return $}async function i0(){let E=await Q(),M=[["id","title","artist","album","genre","year","durationSeconds","playCount","lastPlayed","listeningTimeSeconds"].join(",")];(E||[]).forEach((B)=>{let G=Number.isFinite(Number(B.playCount))?Number(B.playCount):0,X=Number.isFinite(Number(B.duration))?Number(B.duration):0,Y=G*X,Z=[B.id,B.title||"",B.artist||"",B.album||"",B.genre||"",B.year||"",X,G,B.lastPlayed||"",Y].map(n1);M.push(Z.join(","))});let J=`player0-stats-${new Date().toISOString().slice(0,10)}.csv`;i1(J,M.join(`
`),"text/csv")}function l0(E){let $=Math.max(0,Math.floor(Number(E)||0)),M=Math.floor($/3600),J=Math.floor($%3600/60),B=$%60;if(M>0)return`${M}:${String(J).padStart(2,"0")}:${String(B).padStart(2,"0")}`;return`${J}:${String(B).padStart(2,"0")}`}function n0(E,$){let M=URL.createObjectURL($),J=document.createElement("a");J.href=M,J.download=E,document.body.appendChild(J),J.click(),J.remove(),URL.revokeObjectURL(M)}async function aE(){let E=await t(),$={};try{for(let B=0;B<localStorage.length;B++){let G=localStorage.key(B);if(!G||!G.startsWith("player0."))continue;$[G]=localStorage.getItem(G)}}catch{}let M={version:1,exportedAt:new Date().toISOString(),playlists:(E||[]).map((B)=>({name:B.name,description:B.description||"",songIds:Array.isArray(B.songIds)?B.songIds:[]})),settings:$},J=new Blob([JSON.stringify(M,null,2)],{type:"application/json"});n0(`player0-playlists-${new Date().toISOString().slice(0,10)}.json`,J)}function s1(E){if(!E)return[];return(Array.isArray(E)?E:Array.isArray(E.playlists)?E.playlists:[]).map((M)=>({name:String(M?.name||"").trim(),description:String(M?.description||"").trim(),songIds:Array.isArray(M?.songIds)?M.songIds.filter(Boolean):[]})).filter((M)=>M.name.length>0)}async function eE(E){if(!E)return;let $=await E.text(),M;try{M=JSON.parse($)}catch{throw Error("Invalid JSON file")}try{let B=M&&typeof M==="object"?M.settings:null;if(B&&typeof B==="object")for(let[G,X]of Object.entries(B)){if(typeof G!=="string"||!G.startsWith("player0."))continue;localStorage.setItem(G,String(X??""))}}catch{}let J=s1(M);if(J.length===0)throw Error("No playlists found in file");for(let B of J)await B0(B.name,B.description,B.songIds);h()}function s0(E){let $=String(E||"playlist").replace(/\.[^/.]+$/,"").trim().slice(0,80);return $.length?$:"playlist"}function sE(E){let $=String(E||"").trim();if(!$)return"";if($=$.replace(/^['"]|['"]$/g,""),$.startsWith("file://")){$=$.replace(/^file:\/\//,"");try{$=decodeURIComponent($)}catch{}}return $=$.replace(/\\/g,"/"),$}function a1(E){let $=[];for(let M of String(E||"").split(/\r?\n/)){let J=M.trim();if(!J)continue;if(J.startsWith("#"))continue;$.push(J)}return $}function e1(E){let $=new Map;for(let B of String(E||"").split(/\r?\n/)){let G=B.trim();if(!G)continue;if(G.startsWith(";"))continue;if(G.startsWith("[")&&G.endsWith("]"))continue;let X=G.indexOf("=");if(X===-1)continue;let Y=G.slice(0,X).trim(),Z=G.slice(X+1).trim(),O=/^File(\d+)$/i.exec(Y);if(!O)continue;let V=Number(O[1]);if(!Number.isFinite(V)||V<=0)continue;$.set(V,Z)}let M=Math.max(0,...$.keys()),J=[];for(let B=1;B<=M;B++){let G=$.get(B);if(G)J.push(G)}return J}function E2(E){let $=Number.isFinite(E?.duration)?Math.round(E.duration):-1,M=E?.artist?String(E.artist):"",J=E?.title?String(E.title):"",B=[M,J].filter(Boolean).join(" - ")||J||"Unknown";return`#EXTINF:${$},${B}`}function A0(E,$){let M=s0(E),J=["#EXTM3U"];for(let G of $||[]){if(!G?.filePath)continue;J.push(E2(G)),J.push(String(G.filePath))}let B=new Blob([J.join(`
`)+`
`],{type:"audio/x-mpegurl"});n0(`player0-${M}.m3u8`,B)}function k0(E,$){let M=s0(E),J=($||[]).filter((X)=>X?.filePath),B=["[playlist]"];J.forEach((X,Y)=>{let Z=Y+1,O=Number.isFinite(X?.duration)?Math.round(X.duration):-1,V=X?.artist?String(X.artist):"",f=X?.title?String(X.title):"",K=[V,f].filter(Boolean).join(" - ")||f||"Unknown";B.push(`File${Z}=${String(X.filePath)}`),B.push(`Title${Z}=${K}`),B.push(`Length${Z}=${O}`)}),B.push(`NumberOfEntries=${J.length}`),B.push("Version=2");let G=new Blob([B.join(`
`)+`
`],{type:"audio/x-scpls"});n0(`player0-${M}.pls`,G)}async function E1(E){if(!E)return;let $=String(E.name||"").toLowerCase(),M=await E.text(),J;if($.endsWith(".pls"))J=e1(M);else if($.endsWith(".m3u")||$.endsWith(".m3u8"))J=a1(M);else throw Error("Unsupported playlist file type (use .m3u/.m3u8/.pls)");if(!J||J.length===0)throw Error("No entries found in playlist file");let B=await Q(),G=new Map,X=new Map;for(let f of B||[]){let K=f?.filePath;if(!K)continue;let W=sE(K);G.set(W,f.id);let N=W.split("/").pop()?.toLowerCase();if(N&&!X.has(N))X.set(N,f.id)}let Y=[],Z=0;for(let f of J){let K=sE(f);if(!K)continue;let W=G.get(K);if(W){Y.push(W);continue}let N=K.split("/").pop()?.toLowerCase(),T=N?X.get(N):null;if(T)Y.push(T);else Z++}let O=s0(E.name),V=await B0(O,"",Y);return h(),{playlistId:V?.id,playlistName:V?.name||O,importedCount:Y.length,missingCount:Z}}function $1(){let E=document.getElementById("exportStatsCsvButton");if(E)E.onclick=()=>{i0()};let $=document.getElementById("settingsExportPlaylistsJson");if($)$.onclick=()=>{aE().catch((f)=>{console.error("Export playlists failed:",f),alert("Export failed: "+(f?.message||f))})};let M=document.getElementById("settingsImportPlaylistsJson"),J=document.getElementById("settingsPlaylistsJsonFile");if(M&&J)M.onclick=()=>J.click(),J.onchange=()=>{let f=J.files?.[0];if(!f)return;(async()=>{try{await eE(f),alert("Import complete")}catch(K){console.error("Import playlists failed:",K),alert("Import failed: "+(K?.message||K))}finally{J.value=""}})()};let B=document.getElementById("settingsImportPlaylistsM3uPls"),G=document.getElementById("settingsPlaylistsM3uPlsFile");if(B&&G)B.onclick=()=>G.click(),G.onchange=()=>{let f=G.files?.[0];if(!f)return;(async()=>{try{let K=await E1(f);if(K)alert(`Imported playlist "${K.playlistName}". Added ${K.importedCount} tracks`+(K.missingCount?`, skipped ${K.missingCount} missing.`:"."));else alert("Import complete");O()}catch(K){console.error("Import M3U/PLS failed:",K),alert("Import failed: "+(K?.message||K))}finally{G.value=""}})()};let X=document.getElementById("settingsPlaylistExportSelect"),Y=document.getElementById("settingsExportPlaylistM3U"),Z=document.getElementById("settingsExportPlaylistPLS");if(X&&Y&&Z)Y.onclick=()=>void V("m3u"),Z.onclick=()=>void V("pls"),O();async function O(){let f=document.getElementById("settingsPlaylistExportSelect");if(!f)return;try{let K=await t(),W=f.value;f.innerHTML="";let N=Array.isArray(K)?K:[];if(N.length===0){let T=document.createElement("option");T.value="",T.textContent="No playlists available",f.appendChild(T),f.disabled=!0;return}f.disabled=!1;for(let T of N){let q=document.createElement("option");q.value=T.id,q.textContent=T.name,f.appendChild(q)}if(W&&Array.from(f.options).some((T)=>T.value===W))f.value=W}catch(K){console.error("Failed to load playlists for export:",K)}}async function V(f){let K=document.getElementById("settingsPlaylistExportSelect");if(!K)return;let W=K.value;if(!W){alert("Select a playlist to export");return}try{let N=await a(W),T=await Q(),q=(N.songIds||[]).map((b)=>(T||[]).find((i)=>i.id===b)).filter(Boolean);if(f==="m3u")A0(N.name,q);else k0(N.name,q)}catch(N){console.error("Export playlist failed:",N),alert("Export failed: "+(N?.message||N))}}}async function v(E,$=!0){let M=document.getElementById("viewContainer");if(!M)return;if(window.matchMedia("(max-width: 700px)").matches){document.body.classList.remove("mobile-search-open"),document.getElementById("searchInput")?.blur();let G=document.getElementById("advancedSearch");if(G)G.style.display="none";document.getElementById("advancedSearchToggle")?.classList.remove("active")}let J={library:"library.html",albums:"albums.html",artists:"artists.html",playlists:"playlists.html",playlistDetailView:"playlist-detail.html",albumDetailView:"album-detail.html",stats:"stats.html",settings:"settings.html"},B=J[E]||J[E.replace("View","")];if(!B)return;try{let X=await(await fetch(`/views/${B}`)).text();if(M.innerHTML=X,M.style.animation="fadeIn 0.3s ease-out",$){let Y=E.replace("View","");window.location.hash=`#/${Y}`}switch(document.querySelectorAll(".nav-item").forEach((Y)=>{if(Y.classList.remove("active"),Y.dataset.view===E||Y.dataset.view===E.replace("View",""))Y.classList.add("active")}),E){case"library":yE();break;case"albums":uE();break;case"artists":lE();break;case"playlists":f0();break;case"stats":nE();break;case"settings":$1();break}}catch(G){console.error("Error loading view:",G),M.innerHTML='<div class="error">Failed to load view</div>'}}async function M1(){let E=async()=>{let M=window.location.hash.slice(2).split("/"),J=M[0];if(J&&J!=="")if(J==="playlist"&&M[1])await V0(M[1]);else if(J==="album"&&M[1]&&M[2])await u0(decodeURIComponent(M[1]),decodeURIComponent(M[2]));else await v(J,!1);else await v("library",!1)};window.addEventListener("hashchange",()=>{E()}),await E()}var $2=null,w0=[];function e0(){try{return localStorage.getItem("player0.playlists.sort")||"pinned"}catch{return"pinned"}}function M2(E){try{localStorage.setItem("player0.playlists.sort",E)}catch{}}function a0(E){return String(E||"").trim().toLowerCase()}function EE(E,{query:$,sortMode:M}={}){let J=a0($),B=J?(E||[]).filter((X)=>{let Y=a0(X?.name),Z=a0(X?.description);return Y.includes(J)||Z.includes(J)}):E||[],G=(X,Y)=>String(X?.name||"").localeCompare(String(Y?.name||""));if(M==="songs")return[...B].sort((X,Y)=>{let Z=Number(X?.songCount||0),O=Number(Y?.songCount||0);if(Z!==O)return O-Z;return G(X,Y)});if(M==="name")return[...B].sort(G);return[...B].sort((X,Y)=>{let Z=Boolean(X?.pinned),O=Boolean(Y?.pinned);if(Z!==O)return Z?-1:1;return G(X,Y)})}function J2(){let E=document.getElementById("playlistSearch"),$=document.getElementById("playlistSort"),M=document.getElementById("playlistGrid");if($&&!$.dataset.wired)$.dataset.wired="1",$.value=e0(),$.addEventListener("change",()=>{M2($.value);let J=EE(w0,{query:E?.value,sortMode:$.value});C0(J)});if(E&&!E.dataset.wired)E.dataset.wired="1",E.addEventListener("input",()=>{let J=EE(w0,{query:E.value,sortMode:$?.value||e0()});C0(J)});if(M&&!M.dataset.pinHandlerAttached)M.dataset.pinHandlerAttached="1",M.addEventListener("click",(J)=>{let B=J.target.closest(".playlist-pin-btn");if(!B)return;J.preventDefault(),J.stopPropagation();let G=B.dataset.playlistId,X=B.dataset.pinned==="1";if(!G)return;(async()=>{try{await g(G,{pinned:!X}),await f0()}catch(Y){console.error("Toggle pin failed:",Y),alert("Failed to pin playlist: "+(Y?.message||Y))}})()})}async function f0(){try{let E=await t();w0=Array.isArray(E)?E:[];let $=document.getElementById("playlistSort")?.value||e0(),M=document.getElementById("playlistSearch")?.value||"";C0(EE(w0,{query:M,sortMode:$})),J2();let J=document.getElementById("createPlaylist");if(J)J.onclick=c0}catch(E){console.error("Error loading playlists:",E)}}function c0(){let E=arguments?.[0],$=E?.mode==="edit"?"edit":"create",M=E?.playlist||null,J=document.getElementById("playlistModal"),B=J?.querySelector(".modal-header h3"),G=document.getElementById("savePlaylist");if($==="edit"&&M?.id){if(J.dataset.editingPlaylistId=String(M.id),B)B.textContent="Edit Playlist";if(G)G.textContent="Save Changes";document.getElementById("playlistName").value=M.name||"",document.getElementById("playlistDescription").value=M.description||""}else{if(delete J.dataset.editingPlaylistId,B)B.textContent="Create New Playlist";if(G)G.textContent="Create Playlist";document.getElementById("playlistName").value="",document.getElementById("playlistDescription").value=""}J.style.display="flex",document.getElementById("playlistName").focus()}function O0(){let E=document.getElementById("playlistModal");if(!E)return;E.style.display="none",delete E.dataset.editingPlaylistId}async function J1(){let E=document.getElementById("playlistName").value.trim(),$=document.getElementById("playlistDescription").value.trim(),J=document.getElementById("playlistModal")?.dataset?.editingPlaylistId;if(!E){alert("Please enter a playlist name");return}try{if(J)await g(J,{name:E,description:$});else await B0(E,$,[]);O0(),h(),f0()}catch(B){console.error("Error creating playlist:",B),alert("Error: "+B.message)}}async function B1(E,$){try{await WE(E,$),h(),await V0(E)}catch(M){console.error("Error removing from playlist:",M),alert("Error: "+M.message)}}function B2(E,$){j(E),k(E,$),H(E[$])}async function V0(E){try{let $=await a(E),M=await Q(),J=($.songIds||[]).map((f)=>M.find((K)=>K.id===f)).filter(Boolean);window.currentPlaylistId=E,window.currentPlaylistSongs=J,await v("playlistDetailView",!1),window.location.hash=`#/playlist/${E}`,await new Promise((f)=>setTimeout(f,0)),p0($,J);let B=document.getElementById("backToPlaylists");if(B)B.onclick=()=>{window.location.hash="#/playlists"};let G=document.getElementById("playPlaylistAll");if(G)G.onclick=()=>{if(J.length>0)j(J),k(J,0),H(J[0])};let X=document.getElementById("playlistShuffle");if(X)X.onclick=()=>{if(!J.length)return;let f=[...J].map((K)=>({s:K,r:Math.random()})).sort((K,W)=>K.r-W.r).map((K)=>K.s);j(f),k(f,0),H(f[0])};let Y=document.getElementById("playlistEdit");if(Y)Y.onclick=()=>{c0({mode:"edit",playlist:$})};let Z=document.getElementById("playlistDelete");if(Z)Z.onclick=()=>{if(!confirm(`Delete playlist "${$.name||"Untitled Playlist"}"?`))return;(async()=>{try{await VE(E),h(),window.location.hash="#/playlists",await f0()}catch(K){console.error("Delete playlist failed:",K),alert("Delete failed: "+(K?.message||K))}})()};let O=document.getElementById("playlistExportM3U");if(O)O.onclick=()=>{A0($.name,J)};let V=document.getElementById("playlistExportPLS");if(V)V.onclick=()=>{k0($.name,J)}}catch($){console.error("Error loading playlist:",$),alert("Error loading playlist: "+$.message)}}async function G2(E){$2=E;let $=document.getElementById("addToPlaylistModal"),M=document.getElementById("playlistSelectionList");try{let J=await t();if(M.innerHTML="",J.length===0)M.innerHTML='<p style="text-align: center; color: var(--text-secondary); padding: 24px;">No playlists yet. Create one below!</p>';else J.forEach((B)=>{let G=document.createElement("div");G.className="playlist-selection-item",G.innerHTML=`
          <div>
            <div style="font-weight: 500;">${X2(B.name)}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${B.songCount||0} songs</div>
          </div>
        `,G.onclick=async()=>{try{if(await OE(B.id,E),$.style.display="none",h(),window.currentPlaylistId===B.id)await V0(B.id);alert(`Added to ${B.name}`)}catch(X){console.error("Error adding to playlist:",X),alert("Error: "+X.message)}},M.appendChild(G)});$.style.display="flex"}catch(J){console.error("Error loading playlists:",J),alert("Error loading playlists")}}function X2(E){let $=document.createElement("div");return $.textContent=E,$.innerHTML}window.onPlaySongFromPlaylist=B2;window.loadPlaylistDetail=V0;window.openAddToPlaylistModal=G2;function G1(){let E=document.getElementById("closePlaylistModal"),$=document.getElementById("cancelPlaylist"),M=document.getElementById("savePlaylist");if(E)E.onclick=()=>O0();if($)$.onclick=()=>O0();if(M)M.onclick=()=>{J1()};let J=document.getElementById("playlistModal");if(J)J.onclick=(K)=>{if(K.target?.id==="playlistModal")O0()};let B=document.getElementById("closeAddToPlaylistModal"),G=document.getElementById("addToPlaylistModal");if(B&&G)B.onclick=()=>{G.style.display="none"};let X=document.getElementById("createNewPlaylistFromAdd");if(X&&G)X.onclick=()=>{G.style.display="none",c0()};let Y=document.getElementById("keyboardShortcutsBtn"),Z=document.getElementById("keyboardShortcutsModal"),O=document.getElementById("closeShortcutsModal");if(Y&&Z)Y.onclick=()=>{Z.style.display="flex"};if(O&&Z)O.onclick=()=>{Z.style.display="none"};if(Z)Z.onclick=(K)=>{if(K.target?.id==="keyboardShortcutsModal")Z.style.display="none"};let V=document.getElementById("statsListModal"),f=document.getElementById("closeStatsListModal");if(f&&V)f.onclick=()=>{V.style.display="none"},V.onclick=(K)=>{if(K.target?.id==="statsListModal")V.style.display="none"}}function X1(){["playlistModal","addToPlaylistModal","keyboardShortcutsModal","statsListModal"].forEach(($)=>{let M=document.getElementById($);if(M)M.style.display="none"})}async function Y1(){let E=document.getElementById("scanButton");if(!E)return;E.disabled=!0,E.innerHTML='<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg><span>Scanning...</span>';try{let $=await NE();h(),alert(`Scan complete!
Added: ${$.added}
Updated: ${$.updated}
Total: ${$.total}`),window.location.reload()}catch($){console.error("Scan error:",$),alert("Error scanning library"),E.disabled=!1,E.innerHTML='<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg><span>Scan Library</span>'}}async function Y2(E){let $=String(E||"").trim();if(!$)return;try{await navigator.clipboard.writeText($);return}catch{}let M=document.createElement("textarea");M.value=$,M.setAttribute("readonly",""),M.style.position="fixed",M.style.top="-9999px",M.style.left="-9999px",document.body.appendChild(M),M.select();try{document.execCommand("copy")}finally{M.remove()}}function Z1(E){let $=E?.dataset?.songId,M=E?.dataset?.songContext,J=Number(E?.dataset?.songIndex),B=(Z)=>{if(!Array.isArray(Z)||Z.length===0)return null;if(Number.isFinite(J)&&J>=0&&J<Z.length){let O=Z[J];if(O&&(!$||O.id===$))return O}if($)return Z.find((O)=>O?.id===$)||null;return null};if(M==="playlist"){let Z=B(window.currentPlaylistSongs);if(Z)return Z}let G=B(S);if(G)return G;let X=B(RE);if(X)return X;let Y=B(window.currentPlaylistSongs);if(Y)return Y;return null}function K1(){document.querySelectorAll(".nav-item").forEach((E)=>{E.addEventListener("click",($)=>{if($.preventDefault(),E.dataset.action==="search"){if(!window.matchMedia("(max-width: 700px)").matches)return;if(!document.body.classList.toggle("mobile-search-open")){document.getElementById("searchInput")?.blur();let Z=document.getElementById("advancedSearch");if(Z)Z.style.display="none";document.getElementById("advancedSearchToggle")?.classList.remove("active");return}document.querySelector(".header")?.scrollIntoView({behavior:"smooth",block:"start"});let Y=document.getElementById("searchInput");if(Y)Y.focus(),Y.select?.();return}let J=E.dataset.view;if(!J)return;v(J)})}),document.getElementById("scanButton")?.addEventListener("click",()=>{Y1()}),document.addEventListener("click",(E)=>{if(E.target.closest(".add-to-playlist-btn")){let M=E.target.closest(".add-to-playlist-btn").dataset.songId;if(M)window.openAddToPlaylistModal?.(M)}if(E.target.closest(".remove-from-playlist-btn")){let M=E.target.closest(".remove-from-playlist-btn").dataset.songId;if(M&&window.currentPlaylistId)B1(window.currentPlaylistId,M)}if(E.target.closest(".song-copy-btn")){let M=E.target.closest(".song-copy-btn").dataset.copyText;Y2(M)}if(E.target.closest(".song-row-queue-btn")){let $=E.target.closest(".song-row-queue-btn"),M=Z1($);if(!M)return;qE(M),I()}if(E.target.closest(".song-row-play-next-btn")){let $=E.target.closest(".song-row-play-next-btn"),M=Z1($);if(!M)return;AE(M),I()}})}function f1(){let E=document.getElementById("audioPlayer");if(!E)return;let $=document.getElementById("playPauseButton"),M=document.getElementById("prevButton"),J=document.getElementById("nextButton"),B=document.getElementById("progressBar"),G=document.getElementById("volumeSlider");hE(E),$?.addEventListener("click",j0),M?.addEventListener("click",H0),J?.addEventListener("click",Y0),B?.addEventListener("input",(X)=>{SE(X.target.value)}),G?.addEventListener("input",(X)=>{Q0(X.target.value/100)}),document.addEventListener("keydown",(X)=>{let Y=X.target?.tagName;if(Y==="INPUT"||Y==="TEXTAREA")if((X.ctrlKey||X.metaKey)&&(X.key==="f"||X.key==="k"));else return;switch(X.key){case" ":X.preventDefault(),j0();break;case"ArrowRight":X.preventDefault(),Y0();break;case"ArrowLeft":X.preventDefault(),H0();break;case"s":case"S":X.preventDefault(),document.getElementById("shuffleButton")?.click();break;case"r":case"R":X.preventDefault(),document.getElementById("repeatButton")?.click();break;case"ArrowUp":{X.preventDefault();let Z=E.volume;if(Q0(Math.min(1,Z+0.1)),G)G.value=String(Math.min(100,Number(G.value||0)+10));break}case"ArrowDown":{X.preventDefault();let Z=E.volume;if(Q0(Math.max(0,Z-0.1)),G)G.value=String(Math.max(0,Number(G.value||0)-10));break}case"k":if(X.ctrlKey||X.metaKey)X.preventDefault(),document.getElementById("searchInput")?.focus();break;case"p":if(X.ctrlKey||X.metaKey){X.preventDefault();let Z=document.getElementById("keyboardShortcutsModal");if(Z)Z.style.display="flex"}break;case"Escape":X1();break}}),document.getElementById("miniPlayPause")?.addEventListener("click",j0),document.getElementById("miniPrev")?.addEventListener("click",H0),document.getElementById("miniNext")?.addEventListener("click",Y0)}function V1(){let E=window.__player0PendingHideSidebarTimeout;if(E)clearTimeout(E),window.__player0PendingHideSidebarTimeout=null}function L0(E){window.__player0PendingHideSidebarTimeout=E}function O1(){let E=document.getElementById("nowPlayingSidebar"),$=document.getElementById("miniPlayer"),M=document.querySelector(".app-container"),J=document.getElementById("closeSidebar"),B=document.getElementById("expandSidebar"),G=document.getElementById("miniQueue");if(!E||!$||!M)return;function X(){return window.matchMedia("(max-width: 700px)").matches}function Y({scrollToQueue:Z=!1}={}){if(V1(),E.style.display="flex",requestAnimationFrame(()=>{E.style.transform=X()?"translateY(0)":"translateX(0)"}),$.style.transform="translateY(100%)",L0(setTimeout(()=>{$.style.display="none",L0(null)},400)),M.classList.remove("sidebar-closed"),Z)setTimeout(()=>{E.querySelector(".np-queue")?.scrollIntoView({block:"start",behavior:"smooth"})},0)}J?.addEventListener("click",()=>{if(E.style.transform=X()?"translateY(100%)":"translateX(320px)",document.body.classList.contains("has-mini-player"))$.style.display="flex",requestAnimationFrame(()=>{$.style.transform="translateY(0)"});else $.style.display="none",$.style.transform="translateY(100%)";V1(),L0(setTimeout(()=>{E.style.display="none",L0(null)},400)),M.classList.add("sidebar-closed")}),B?.addEventListener("click",()=>{Y({scrollToQueue:!1})}),G?.addEventListener("click",()=>{if(E.style.display!=="none"&&!M.classList.contains("sidebar-closed")){E.querySelector(".np-queue")?.scrollIntoView({block:"start",behavior:"smooth"});return}Y({scrollToQueue:!0})})}var W1=!1;function $E(E){if(!E)return;E.classList.remove("is-fixed"),E.style.left="",E.style.top="",E.style.minWidth="",E.style.maxHeight="",E.style.overflowY=""}function N1(E){let $=E?.querySelector?.("[data-dropdown-trigger]"),M=E?.querySelector?.(".dropdown-menu");if(!$||!M)return;M.classList.add("is-fixed");let J=$.getBoundingClientRect(),B=Math.ceil(J.width);M.style.minWidth=`${Math.max(180,B)}px`;let G=Math.ceil(M.offsetWidth),X=Math.ceil(M.offsetHeight),Y=8,Z=J.right-G;Z=Math.max(Y,Math.min(Z,window.innerWidth-Y-G));let O=J.bottom+Y;if(O+X>window.innerHeight-Y)O=J.top-Y-X;let f=window.innerHeight-Y-X;O=Math.max(Y,Math.min(O,Math.max(Y,f)));let K=window.innerHeight-Y-O;M.style.maxHeight=`${Math.max(160,K)}px`,M.style.overflowY="auto",M.style.left=`${Math.round(Z)}px`,M.style.top=`${Math.round(O)}px`}function z1(){document.querySelectorAll(".dropdown.is-open").forEach((E)=>{N1(E)})}function v0(E=null){document.querySelectorAll(".dropdown.is-open").forEach(($)=>{if(E&&$===E)return;$.classList.remove("is-open");let M=$.querySelector("[data-dropdown-trigger]");if(M)M.setAttribute("aria-expanded","false");$E($.querySelector(".dropdown-menu"))})}function Z2(E){let $=E.closest(".dropdown");if(!$)return;let M=!$.classList.contains("is-open");if(v0($),$.classList.toggle("is-open",M),E.setAttribute("aria-expanded",M?"true":"false"),M)queueMicrotask(()=>{N1($);let J=$.querySelector(".dropdown-menu .dropdown-item");if(J)J.focus()});else $E($.querySelector(".dropdown-menu"))}function R1(){if(W1)return;W1=!0,document.addEventListener("click",(E)=>{let $=E.target?.closest?.("[data-dropdown-trigger]");if($){E.preventDefault(),Z2($);return}let M=E.target?.closest?.(".dropdown-item");if(M){let J=M.closest(".dropdown");if(J){J.classList.remove("is-open");let B=J.querySelector("[data-dropdown-trigger]");if(B)B.setAttribute("aria-expanded","false");$E(J.querySelector(".dropdown-menu"))}return}if(!E.target?.closest?.(".dropdown"))v0()}),document.addEventListener("keydown",(E)=>{if(E.key==="Escape"){v0();return}let $=document.querySelector(".dropdown.is-open");if(!$)return;let M=Array.from($.querySelectorAll(".dropdown-menu .dropdown-item"));if(M.length===0)return;let J=document.activeElement,B=M.indexOf(J);if(E.key==="ArrowDown"){E.preventDefault(),M[(B+1+M.length)%M.length].focus();return}if(E.key==="ArrowUp"){E.preventDefault(),M[(B-1+M.length)%M.length].focus();return}if(E.key==="Enter"&&B>=0)E.preventDefault(),M[B].click()}),window.addEventListener("blur",()=>v0()),window.addEventListener("resize",()=>z1()),window.addEventListener("scroll",()=>z1(),!0)}function _1(){document.addEventListener("DOMContentLoaded",async()=>{wE(),K1(),oE(),f1(),O1(),G1(),R1(),await M1();let E=document.getElementById("nowPlayingSidebar"),$=document.getElementById("miniPlayer"),J=window.matchMedia("(max-width: 700px)").matches;if(E)E.style.display="none",E.style.transform=J?"translateY(100%)":"translateX(320px)";if($)$.style.display="none",$.style.transform="translateY(100%)";document.querySelector(".app-container")?.classList.add("sidebar-closed")})}if("serviceWorker"in navigator)window.addEventListener("load",async()=>{try{let E=await navigator.serviceWorker.register("/sw.js",{scope:"/"});console.log("Service Worker registered:",E.scope),E.addEventListener("updatefound",()=>{let $=E.installing;console.log("Service Worker update found"),$?.addEventListener("statechange",()=>{if($.state==="installed"&&navigator.serviceWorker.controller){if(console.log("New version available! Refresh to update."),window.showUpdateNotification)window.showUpdateNotification()}})})}catch(E){console.error("Service Worker registration failed:",E)}});_1();

//# debugId=8B334CF9AAFF3FE264756E2164756E21
